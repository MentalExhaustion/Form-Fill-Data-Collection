<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Confirm Deletion</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
    :root {
      --primary-color: #38e07b;
      --secondary-color: #2cc26a;
      --background-color: #f8fcf9;
      --text-primary: #1a1a1a;
      --text-secondary: #4d4d4d;
      --accent-color: #d0f7e0;
      --danger-color: #ef4444;
      --danger-hover: #dc2626;
      --br-none: 0;
      --br-sm: 0.125rem;
      --br-md: 0.375rem;
      --br-lg: 0.5rem;
      --br-xl: 0.75rem;
      --br-2xl: 1rem;
      --br-3xl: 1.5rem;
      --br-full: 9999px;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-color);
      color: var(--text-primary);
    }
  </style>
</head>
<body class="font-sans">
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all duration-300 ease-out scale-100 opacity-100">
<div class="flex flex-col items-center text-center">
<div class="bg-[var(--danger-color)]/10 p-3 rounded-full mb-4">
<span class="material-symbols-outlined text-4xl text-[var(--danger-color)]">
                delete
            </span>
</div>
<h2 class="text-xl font-semibold text-[var(--text-primary)]">Confirm Deletion</h2>
<p class="text-base text-[var(--text-secondary)] leading-relaxed mt-2 mb-6">Are you sure you want to delete this entry? This action cannot be undone.</p>
<div class="flex justify-center space-x-3 w-full">
<button id="cancel-btn" class="bg-gray-200 text-[var(--text-secondary)] px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition-colors duration-200 flex-1">
            Cancel
          </button>
<button id="delete-btn" class="bg-[var(--danger-color)] text-white px-4 py-2 rounded-md hover:bg-[var(--danger-hover)] focus:outline-none focus:ring-2 focus:ring-[var(--danger-color)] focus:ring-opacity-50 transition-colors duration-200 flex-1 disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="delete-text">Delete</span>
            <svg id="delete-spinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
</div>
</div>
</div>
</div>

<script src="main.js" type="module"></script>
<script type="module">
  let submissionToDelete = null;
  
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('Admin 3 (Delete Confirmation) loaded');
    
    // Check if user is logged in
    const userData = localStorage.getItem('userData');
    if (!userData) {
      alert('Please login to access admin panel');
      window.location.href = 'login.html';
      return;
    }
    
    // Get submission ID to delete
    const submissionId = localStorage.getItem('deleteSubmissionId');
    if (!submissionId) {
      alert('No submission selected for deletion');
      window.location.href = 'admin 1.html';
      return;
    }
    
    submissionToDelete = submissionId;
    
    // Wait for Firebase to be ready
    await waitForFirebase();
    
    // Setup event listeners
    setupEventListeners();
  });
  
  async function waitForFirebase() {
    return new Promise((resolve) => {
      if (window.firebaseApp) {
        resolve();
      } else {
        window.addEventListener('firebaseReady', resolve, { once: true });
        setTimeout(() => {
          if (window.firebaseApp) resolve();
        }, 2000);
      }
    });
  }
  
  function setupEventListeners() {
    const cancelBtn = document.getElementById('cancel-btn');
    const deleteBtn = document.getElementById('delete-btn');
    
    cancelBtn.addEventListener('click', () => {
      // Go back to submissions list
      localStorage.removeItem('deleteSubmissionId');
      window.location.href = 'admin 1.html';
    });
    
    deleteBtn.addEventListener('click', async () => {
      await deleteSubmission();
    });
  }
  
  async function deleteSubmission() {
    if (!submissionToDelete) return;
    
    const deleteBtn = document.getElementById('delete-btn');
    const deleteText = document.getElementById('delete-text');
    const deleteSpinner = document.getElementById('delete-spinner');
    
    // Show loading state
    deleteBtn.disabled = true;
    deleteText.textContent = 'Deleting...';
    deleteSpinner.classList.remove('hidden');
    
    try {
      console.log('Deleting submission:', submissionToDelete);
      
      const { db, doc, deleteDoc } = window.firebaseApp;
      
      // Import deleteDoc function
      const { deleteDoc: deleteDocFromFirestore, doc: docRef } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');
      
      const submissionRef = docRef(db, 'formSubmissions', submissionToDelete);
      await deleteDocFromFirestore(submissionRef);
      
      console.log('Submission deleted successfully');
      
      // Clean up and redirect
      localStorage.removeItem('deleteSubmissionId');
      localStorage.removeItem('currentSubmissionId');
      
      // Show success message briefly
      deleteText.textContent = 'Deleted!';
      deleteSpinner.classList.add('hidden');
      
      setTimeout(() => {
        window.location.href = 'admin 1.html';
      }, 1000);
      
    } catch (error) {
      console.error('Error deleting submission:', error);
      
      // Reset button state
      deleteBtn.disabled = false;
      deleteText.textContent = 'Delete';
      deleteSpinner.classList.add('hidden');
      
      alert('Failed to delete submission. Please try again.');
    }
  }
  
  // Handle ESC key to cancel
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      localStorage.removeItem('deleteSubmissionId');
      window.location.href = 'admin 1.html';
    }
  });
</script>

</body></html>