<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Data Collection App</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
    :root {
      --primary-color: #38e07b;
      --secondary-color: #e6ffe6;
      --background-color: #f8fcf9;
      --text-primary: #1a1a1a;
      --text-secondary: #4d4d4d;
      --accent-color: #2cc26a;
      --border-color: #d1d1d1;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-color);
      color: var(--text-primary);
    }
  </style>
</head>
<body class="bg-[var(--background-color)] text-[var(--text-primary)]">
<div class="flex flex-col min-h-screen">
<header class="bg-white shadow-sm">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<div class="flex items-center gap-4">
<div class="text-[var(--primary-color)]">
<svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"></path>
</svg>
</div>
<h1 class="text-xl font-bold text-[var(--text-primary)]">Data Collection App</h1>
</div>
<div class="flex items-center">
<button id="logout-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-all duration-200 shadow-md hover:shadow-lg">
<span class="flex items-center gap-2">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
</svg>
Logout
</span>
</button>
</div>
</div>
</div>
</header>
<main class="flex-grow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
<div class="max-w-md w-full space-y-8">
<div class="bg-white rounded-xl shadow-lg p-8 border border-[var(--border-color)]">
<div class="text-center mb-8">
<h2 class="text-3xl font-bold text-[var(--text-primary)]">Data Entry Form</h2>
<p class="mt-2 text-sm text-[var(--text-secondary)]">Please fill in the details below.</p>
</div>
              <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
              </div>
<form id="data-form" class="space-y-6" method="POST">
<div>
<label class="block text-sm font-medium text-[var(--text-primary)] mb-1" for="uc-name">UC Name</label>
<input class="block w-full px-4 py-3 border border-[var(--border-color)] rounded-lg bg-white text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition ease-in-out duration-150" id="uc-name" name="uc-name" placeholder="Enter UC Name" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-[var(--text-primary)] mb-1" for="uc-number">UC Number</label>
<input class="block w-full px-4 py-3 border border-[var(--border-color)] rounded-lg bg-white text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition ease-in-out duration-150" id="uc-number" name="uc-number" placeholder="Enter UC Number" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-[var(--text-primary)] mb-1" for="lhw-name">Name of LHW</label>
<input class="block w-full px-4 py-3 border border-[var(--border-color)] rounded-lg bg-white text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition ease-in-out duration-150" id="lhw-name" name="lhw-name" placeholder="Enter LHW Name" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-[var(--text-primary)] mb-1" for="household-name">Name of Household</label>
<input class="block w-full px-4 py-3 border border-[var(--border-color)] rounded-lg bg-white text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition ease-in-out duration-150" id="household-name" name="household-name" placeholder="Enter Household Name" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-[var(--text-primary)] mb-1" for="current-location">Current Location</label>
<div class="relative">
<input class="block w-full pl-4 pr-12 py-3 border border-[var(--border-color)] rounded-lg bg-white text-[var(--text-primary)] placeholder-[var(--text-secondary)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition ease-in-out duration-150" id="current-location" name="current-location" placeholder="Detecting location..." readonly="" type="text"/>
<div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
<span class="material-symbols-outlined text-[var(--text-secondary)]">
                            my_location
                        </span>
</div>
</div>
</div>
<div>
<button id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-semibold text-white bg-[var(--primary-color)] hover:bg-[var(--accent-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-color)] transition ease-in-out duration-150 disabled:opacity-50 disabled:cursor-not-allowed" type="submit">
                <span id="submit-text">Submit Data</span>
                <svg id="loading-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>
              <button id="debug-btn" type="button" class="mt-2 w-full text-sm text-gray-600 hover:text-gray-800 transition-colors duration-200">
                Debug Firebase Status
              </button>
</div>
</form>
</div>
</div>
</main>
</div>

<script src="main.js" type="module"></script>
<script type="module">
  // Wait for Firebase to be initialized
  document.addEventListener('DOMContentLoaded', async () => {
    // Check authentication status
    const userData = localStorage.getItem('userData');
    if (!userData) {
      window.location.href = 'login.html';
      return;
    }

    const user = JSON.parse(userData);
    console.log('User logged in:', user.displayName);

    // Wait for Firebase to be ready
    const waitForFirebase = () => {
      return new Promise((resolve) => {
        if (window.firebaseApp) {
          console.log('Firebase already ready');
          resolve();
        } else {
          console.log('Waiting for Firebase...');
          window.addEventListener('firebaseReady', () => {
            console.log('Firebase ready event received');
            resolve();
          }, { once: true });
          
          // Fallback timeout check
          setTimeout(() => {
            if (window.firebaseApp) {
              console.log('Firebase ready via timeout check');
              resolve();
            }
          }, 2000);
        }
      });
    };
    
    await waitForFirebase();

    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try {
        // Wait for Firebase to be available
        while (!window.firebaseApp) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        const { auth, signOut } = window.firebaseApp;
        
        await signOut(auth);
        localStorage.clear();
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Error signing out:', error);
        // Clear local storage and redirect anyway
        localStorage.clear();
        window.location.href = 'login.html';
      }
    });

    // Get current location
    const locationInput = document.getElementById('current-location');
    const getCurrentLocation = () => {
      if (navigator.geolocation) {
        locationInput.value = 'Getting location...';
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            locationInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          },
          (error) => {
            console.error('Error getting location:', error);
            locationInput.value = 'Location access denied';
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
        );
      } else {
        locationInput.value = 'Geolocation not supported';
      }
    };

    // Get location on page load
    getCurrentLocation();

    // Form validation and submission
    const form = document.getElementById('data-form');
    const errorMessage = document.getElementById('error-message');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    const showError = (message) => {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    };

    const hideError = () => {
      errorMessage.classList.add('hidden');
    };

    const setLoading = (loading) => {
      if (loading) {
        submitBtn.disabled = true;
        submitText.textContent = 'Submitting...';
        loadingSpinner.classList.remove('hidden');
      } else {
        submitBtn.disabled = false;
        submitText.textContent = 'Submit Data';
        loadingSpinner.classList.add('hidden');
      }
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();
      
      console.log('Form submission started');

      // Get form data
      const formData = {
        ucName: document.getElementById('uc-name').value.trim(),
        ucNumber: document.getElementById('uc-number').value.trim(),
        lhwName: document.getElementById('lhw-name').value.trim(),
        householdName: document.getElementById('household-name').value.trim(),
        currentLocation: document.getElementById('current-location').value.trim()
      };

      console.log('Form data collected:', formData);

      // Validate form data (as per project specification)
      const requiredFields = [
        { field: 'ucName', name: 'UC Name' },
        { field: 'ucNumber', name: 'UC Number' },
        { field: 'lhwName', name: 'LHW Name' },
        { field: 'householdName', name: 'Household Name' },
        { field: 'currentLocation', name: 'Current Location' }
      ];

      const emptyFields = requiredFields.filter(({ field }) => !formData[field]);
      
      if (emptyFields.length > 0) {
        showError(`Please fill in the following required fields: ${emptyFields.map(f => f.name).join(', ')}`);
        return;
      }

      if (formData.currentLocation === 'Location access denied' || formData.currentLocation === 'Geolocation not supported') {
        showError('Please allow location access or manually enter your location.');
        return;
      }

      console.log('Validation passed, processing submission...');
      setLoading(true);

      try {
        // Check Firebase availability with detailed logging
        console.log('Checking Firebase availability...');
        if (!window.firebaseApp) {
          console.log('Firebase not available, waiting...');
          
          // Wait with timeout
          let attempts = 0;
          const maxAttempts = 30; // 3 seconds
          while (!window.firebaseApp && attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
            console.log(`Waiting for Firebase... attempt ${attempts}`);
          }
        }

        if (!window.firebaseApp || !window.firebaseApp.db) {
          console.error('Firebase not properly initialized');
          throw new Error('Firebase not initialized properly');
        }

        console.log('Firebase is available, proceeding with submission');
        const { db, addDoc, collection, serverTimestamp } = window.firebaseApp;
        
        console.log('Firebase objects:', { db: !!db, addDoc: !!addDoc, collection: !!collection });

        // Prepare data for submission (following Firebase data structure specification)
        const submissionData = {
          ucName: formData.ucName,
          ucNumber: formData.ucNumber,
          lhwName: formData.lhwName,
          householdName: formData.householdName,
          location: formData.currentLocation,
          currentLocation: formData.currentLocation, // Keep both for compatibility
          latitude: formData.currentLocation.split(',')[0]?.trim() || null,
          longitude: formData.currentLocation.split(',')[1]?.trim() || null,
          submittedBy: {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email
          },
          timestamp: serverTimestamp(),
          submittedAt: new Date().toISOString(),
          createdAt: new Date().toISOString()
        };

        console.log('Submitting to Firestore:', submissionData);

        // Submit to Firestore
        const docRef = await addDoc(collection(db, 'formSubmissions'), submissionData);
        console.log('Successfully submitted! Document ID:', docRef.id);

        // Store submission data for confirmation page
        localStorage.setItem('lastSubmissionId', docRef.id);
        localStorage.setItem('lastSubmissionData', JSON.stringify({
          ...submissionData,
          id: docRef.id
        }));

        console.log('Data stored in localStorage, redirecting...');
        
        // Reset loading state before redirect
        setLoading(false);
        
        // Small delay to ensure Firebase write is complete
        setTimeout(() => {
          window.location.href = 'submission_confirmation.html';
        }, 500);
        
      } catch (error) {
        console.error('Error submitting form:', error);
        
        let errorMsg = 'Failed to submit form. Please try again.';
        
        if (error.message.includes('Firebase not initialized')) {
          errorMsg = 'System is loading. Please wait a moment and try again.';
        } else if (error.message.includes('network') || error.code === 'unavailable') {
          errorMsg = 'Network error. Please check your internet connection and try again.';
        } else if (error.code === 'permission-denied') {
          errorMsg = 'Permission denied. Please refresh the page and login again.';
        }
        
        // Show error to user
        showError(errorMsg);
        
        // Also try fallback method to save locally
        console.log('Trying fallback method...');
        const fallbackData = {
          ucName: formData.ucName,
          ucNumber: formData.ucNumber,
          lhwName: formData.lhwName,
          householdName: formData.householdName,
          location: formData.currentLocation,
          currentLocation: formData.currentLocation,
          latitude: formData.currentLocation.split(',')[0]?.trim() || null,
          longitude: formData.currentLocation.split(',')[1]?.trim() || null,
          submittedBy: {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email
          },
          submittedAt: new Date().toISOString(),
          fallbackSubmission: true,
          id: 'local_' + Date.now()
        };
        
        localStorage.setItem('lastSubmissionId', fallbackData.id);
        localStorage.setItem('lastSubmissionData', JSON.stringify(fallbackData));
        
        // Still redirect to confirmation but with fallback data
        setTimeout(() => {
          window.location.href = 'submission_confirmation.html';
        }, 2000);
        
      } finally {
        setLoading(false);
      }
    });

    // Debug button to check Firebase status
    document.getElementById('debug-btn').addEventListener('click', () => {
      console.log('=== FIREBASE DEBUG INFO ===');
      console.log('window.firebaseApp exists:', !!window.firebaseApp);
      console.log('window.firebaseApp value:', window.firebaseApp);
      console.log('User data:', JSON.parse(localStorage.getItem('userData') || '{}'));
      console.log('Location:', document.getElementById('current-location').value);
      
      let debugMsg = 'Firebase Debug Info:\n';
      debugMsg += `Firebase Available: ${!!window.firebaseApp}\n`;
      
      if (window.firebaseApp) {
        debugMsg += `Auth: ${!!window.firebaseApp.auth}\n`;
        debugMsg += `Database: ${!!window.firebaseApp.db}\n`;
        debugMsg += `addDoc function: ${!!window.firebaseApp.addDoc}\n`;
      } else {
        debugMsg += 'Firebase not initialized yet.\n';
      }
      
      alert(debugMsg);
    });
  });
</script>
</body></html>